<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

    <!-- <script src="../WebResources/ss_contractdocumentjs"></script> -->
    <style>
        table {
            font-size: 12px;
            height: 100%;
            min-height: 100%;
            width: 100%;
            overflow-y: hidden;

        }

        table#mainTbl {
            padding-bottom: 20px;
        }

        table.removetable {
            padding-bottom: 20px;
        }

        a {
            color: black;
        }


        .dropdownPosition {

            float: right;
            z-index: 1;
            margin: -45px -75px 45px 75px;
            width: 100px !important;
            min-width: 100px !important;
        }

        .selectedData {
            float: left;

        }

        .dropdownProductsPosition {

            float: right;
            margin: -45px -75px 45px 75px;
            width: 100px !important;
            min-width: 100px !important;
        }

        table thead th {
            text-align: center;


        }

        #refreshData:hover {
            /* background-color: white; */
        }

        #overlay {
            background: #f5f5f5;
            color: #666666;
            position: fixed;
            height: 100%;
            width: 100%;
            z-index: 1;
            top: 0;
            left: 0;
            float: left;
            text-align: center;
            padding-top: 25%;
            opacity: .50;
        }

        .spinner {

            position: absolute;
            left: 45%;
            top: 30%;
            height: 60px;
            width: 60px;
            margin: 0px auto;
            -webkit-animation: rotation .8s infinite linear;
            -moz-animation: rotation .8s infinite linear;
            -o-animation: rotation .8s infinite linear;
            animation: rotation .8s infinite linear;
            border-left: 6px solid rgba(0, 174, 239, .15);
            border-right: 6px solid rgba(0, 174, 239, .15);
            border-bottom: 6px solid rgba(0, 174, 239, .15);
            border-top: 6px solid rgba(0, 174, 239, .8);
            border-radius: 100%;
            z-index: 5000;
        }

        @-webkit-keyframes rotation {
            from {
                -webkit-transform: rotate(0deg);
            }

            to {
                -webkit-transform: rotate(359deg);
            }
        }

        @-moz-keyframes rotation {
            from {
                -moz-transform: rotate(0deg);
            }

            to {
                -moz-transform: rotate(359deg);
            }
        }

        @-o-keyframes rotation {
            from {
                -o-transform: rotate(0deg);
            }

            to {
                -o-transform: rotate(359deg);
            }
        }

        @keyframes rotation {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(359deg);
            }
        }
        
        .questionnair {
            
            padding-left: 15%;
            padding-right: 15%;
        }
        .backlblue{
            background:#bee5eb;
        }
        .pd5{
            padding: 5px;
        }
        .OppProducts{
            border: 1px solid #bee5eb;
        }
        .OppProducts label{
            font-weight: 400;
        }
        .mt10 {
			margin-top: 10px;
		}

		.pr0 {
			padding-right: 0px;
		}
        .hideit{
            display: none;
        }
        /* csssssss */
    </style>
</head>

<body dir="LTR" lang="en-US" style="overflow-wrap: break-word;" onfocusout="parent.setEmailRange();">
    <!-- <div id="overlay" class="loader hideit">
        <div class="spinner loader"></div>
    </div> -->
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-12" id="mainTblDiv">
                <button class="btn btn-success btn-sm hideit" id="saveContracts" style="font-size: 10px;float: right;margin-right:55px;">Save <i class="fa fa-envelope-square fa-lg" style="float: left;padding: 2px 7px 0px 0px;"></i></button>
                <table class="table table-bordered table-responsive  text-center border border-0" id="mainTbl">
                    <thead class="table-info">
                        <tr>
                            <th></th>
                            <th style="width:35%;">Contract Name</th>
                            <th style="width:10%;">Created On</th>
                            <th style="width:15%;">Contract Owner</th>
                            <th style="width:40%;" id="refreshData" onclick="loadData()" class="text-right">
                                <a href="#">
                                    <span class="glyphicon glyphicon-repeat" style="padding: 0px 5px 0px 5px;"></span>
                                </a>
                            </th>
                         </tr>
                    </thead>
                    <tbody id="contractDetailsTblBody">
                    </tbody>

                </table>
                
            </div>
        </div>
    </div>

<script type="text/javascript">
    $(document).ready(function () {
        resetPartOneFields();
        RetrieveContractDetailsTblData();
        checkInnerQues();
        setTimeout(function(){
            checkInnerQues();
        },3000);
        setTimeout(function(){
            checkInnerQues();
        },5000);
        setTimeout(function(){
            checkInnerQues();
        },8000);
    });
    function checkInnerQues(){
        $(".firstpart select").each(function(){
            var classname;
            var thisvalue = $(this).val();
            var thisid = $(this).attr('dataid');
            var c = $(this).attr('class').split(/\s+/);
            for(var s in c)
                if(c[s].indexOf('q') == 0)
                    classname = c[s];
            if(thisvalue == 0){
                $("." + classname + "_inner").removeClass('hideit');
            } else {
                $("." + classname + "_inner").addClass('hideit');
            }
            if(thisvalue == 1 && classname == "q3_1_1_"+thisid){
                $("." + classname + "_inner").removeClass('hideit');
            } else if(thisvalue == 0 && classname == "q3_1_1_"+thisid){
                $("." + classname + "_inner").addClass('hideit');
            }
            //console.log("Class =>"+classname+"; Value=>"+thisvalue);
        });
    }
    function resetPartOneFields(){
        // First Part Show Hide Fields
			$("body").on('click', '.firstpart select', function () {
				var classname;
                var thisvalue = $(this).val();
                var thisid = $(this).attr('dataid');
				var c = $(this).attr('class').split(/\s+/);
		       	for(var s in c)
		        	if(c[s].indexOf('q') == 0)
		            	classname = c[s];
		        if(thisvalue == 0){
		        	$("." + classname + "_inner").removeClass('hideit');
				} else {
					$("." + classname + "_inner").addClass('hideit');
		        }
		        if(thisvalue == 1 && classname == "q3_1_1_"+thisid){
		        	$("." + classname + "_inner").removeClass('hideit');
				} else if(thisvalue == 0 && classname == "q3_1_1_"+thisid){
					$("." + classname + "_inner").addClass('hideit');
		        }
				// console.log("Class =>"+classname+"; Value=>"+thisvalue);
			});
    }
    // Getting different fields data from account with link opportunityproduct + annotation
    function RetrieveContractDetailsTblData() {
        var accounId = window.parent.Xrm.Page.data.entity.getId();
        var fetchXML2 = `<fetch version="1.0" output-format="xml-platform" mapping="logical" distinct="true" >
                        <entity name="opportunity">
                                <attribute name="ss_autorenewalforsubscriptionterm" />
                                <attribute name="opportunityid" /> 
                                <attribute name="createdon" />
                                <attribute name="ss_standardpaymentterms" />
                                <attribute name="ss_paymentterm14days" />
                                <attribute name="ss_paymenttermdays" />
                                <attribute name="ss_billinguponsignature" />
                                <attribute name="ss_standardpriceincreases" />
                                <attribute name="ss_annualincrease" />
                                <attribute name="ss_caponpriceincreases" />
                                <attribute name="ss_priceincreases" />
                                <attribute name="ss_otherpriceincreases" />
                                <attribute name="ss_increasesallowed" />
                                <attribute name="ss_standardnotificationreq" />
                                <order attribute="createdon" descending="true" />               
                                <filter type="and">                         
                                <condition attribute="parentaccountid" operator="eq" value="`+ accounId + `" />
                                </filter>
                                <link-entity name="annotation" from="objectid" to="opportunityid" link-type="inner" alias="ano">
                                    <attribute name="createdon" />
                                    <attribute name="filename" />
                                    <attribute name="ownerid" />                                  
                                    <filter type="and">
                                        <condition attribute="notetext" operator="like" value="%{{Contract--%" />
                                    </filter>
                                </link-entity>
                        </entity>
                    </fetch>`

        fetchXML2 = "?fetchXml=" + encodeURIComponent(fetchXML2);
        window.parent.Xrm.WebApi.online.retrieveMultipleRecords("opportunity", fetchXML2).then(
            function success(results) {
                // console.log(JSON.stringify(results));
                createContractDetailsRow(results);
            },
            function (error) {
                var errorOptions = { message: "Custom Error Message", details: "Inner exception details" };
                window.parent.Xrm.Navigation.openErrorDialog(errorOptions).then(
                    function (success) {
                        console.log(success);
                    },
                    function (error) {
                        console.log(error);
                    });
            }
        );
    
            
            //$(".loader").hide();
            //$(".loader").fadeOut().delay(2000);
        
    }  
    function createContractDetailsRow(results) {
        for (var i = 0; i < results.entities.length; i++) {
            var name = results.entities[i]["ano.filename"];
            var contractName = name;
            var createdOn = results.entities[i]["ano.createdon"];
            if (createdOn != undefined){
                createdOn = createdOn.substring(0, 10);
            }
            var ownerName = results.entities[i]["ano.ownerid@OData.Community.Display.V1.FormattedValue"];
            var oppID = results.entities[i]["opportunityid"];
        
        
        var markup = "<tr class='app ' id='" + oppID + "_CR' >";
            markup +=  "<td><input type='checkbox' class='expandTbl' >";
            markup +=  "<input type='hidden' value=" + oppID + " id='oppidvalue'>";
            markup +=  "</td>";
            markup +=  "<td style='width:30%;'>" + contractName + "</td>";
            markup +=  "<td>"+ createdOn +"</td>";
            markup +=  "<td>"+ ownerName +"</td>";
            markup +=  "</tr>";

        $("#contractDetailsTblBody").append(markup);

        //setTimeout(function () {
        //1q1
        var autorenewal = results.entities[i]["ss_autorenewalforsubscriptionterm"];
        var standardpaymentterms = results.entities[i]["ss_standardpaymentterms"];
        var paymentterm14days = results.entities[i]["ss_paymentterm14days"];
        var paymenttermdays = results.entities[i]["ss_paymenttermdays"];
        var billinguponsignature = results.entities[i]["ss_billinguponsignature"];
        var standardpriceincreases = results.entities[i]["ss_standardpriceincreases"];
        var annualincrease = results.entities[i]["ss_annualincrease"];
        var caponpriceincreases = results.entities[i]["ss_caponpriceincreases"];
        var priceincreases = results.entities[i]["ss_priceincreases"];
        var otherpriceincreases = results.entities[i]["ss_otherpriceincreases"];
        var increasesallowed = results.entities[i]["ss_increasesallowed"];
        var standardnotificationreq = results.entities[i]["ss_standardnotificationreq"];

        var contractDetailRow = "<tr class='OppProducts' style='display:none;'>";
            contractDetailRow += "<td class='class='text-center' colspan='11' >";

            contractDetailRow += "<div class='questionnair firstpart col-md-12'>";

            contractDetailRow +=  `<div class='col-md-12'>
                                        <div class='col-md-9 text-left'>
                                            <p class='bold'>
                                                <span class='backlblue pd5'>I. Contract length, payment terms and pricing</span>
                                            </p>
                                        </div>
                                        <div class='col-md-3 text-right'>
                                            <span class='backlblue pd5'>Status</span>
                                        </div>
                                    </div>`;

            contractDetailRow += `<div class="col-md-12">
                                    <div class="col-md-9 text-left"><p class="">1- Auto-renewal of subscription</p></div>
                                    <div class="col-md-3 text-right">
                                        <select id="autorenewalforsubscriptionterm_`+oppID+`" class="q1">
                                            <option value="1">Yes</option>
                                            <option value="0">No</option>
                                            <option value="2">N/A</option>
                                        </select>
                                    </div>
                                </div>`;
             //Q1

            contractDetailRow += `<div class="col-md-12">
                                    <div class="col-md-9 text-left"><p class="">2- Standard Payment Terms</p></div>
                                    <div class="col-md-3 text-right">
                                        <select id="standardpaymentterms_`+oppID+`" class="q2_`+oppID+`">
                                            <option value="1">Yes</option>
                                            <option value="0">No</option>
                                            <option value="2">N/A</option>
                                        </select>
                                    </div>
                                </div>`;// Q2
            
            contractDetailRow += `<div class="col-md-12  hideit pr0 q2_`+oppID+`_inner">
                                    <div class="radioBtn crmfield btn-group col-md-12 col-sm-12 col-xs-12 mb8  q2_1">
                                        <div class="fieldlabel col-md-9 text-left">
                                            <label><span class="QNumber">2.1.</span> Payment term 14 days?*</label>
                                        </div>
                                        <div class="btnsyesno col-md-3 text-right q21click">
                                            <select id="paymentterm14days_`+oppID+`" class="q2_1_`+oppID+`">
                                                <option value="1">Yes</option>
                                                <option value="0">No</option>
                                                <option value="2">N/A</option>
                                            </select>
                                            <p class="paymenttermdays2 hideit  mt10 text-right q2_1_`+oppID+`_inner"> Select Days
                                                <select class="selectin input-sm" name="payment_term_days"
                                                    id="paymenttermdays_`+oppID+`">
                                                    <option value="0">--</option>
                                                    <option value="14">14 Days</option>
                                                    <option value="30">30 Days</option>
                                                    <option value="45">45 Days</option>
                                                    <option value="60">60 Days</option>
                                                </select>
                                            </p>
                                        </div>

                                    </div>
                                    <div class="radioBtn crmfield btn-group col-md-12 col-sm-12 col-xs-12 mb8 q2_2">
                                        <div class="fieldlabel col-md-9 text-left">
                                            <label><span class="QNumber">2.2.</span> Billing upon signature?</label>
                                        </div>
                                        <div class="btnsyesno col-md-3 text-right">
                                            <select id="billinguponsignature_`+oppID+`" class="q2_2_`+oppID+`">
                                                <option value="1">Yes</option>
                                                <option value="0">No</option>
                                                <option value="2">N/A</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>`; // Q2_inner
            contractDetailRow +=`<div class="radioBtn crmfield btn-group col-md-12 col-sm-12 col-xs-12 mb8">
                                    <div class="fieldlabel col-md-9 text-left">
                                        <label><span class="QNumber">3.</span> Standard price increases?*</label>
                                    </div>
                                    <div class="btnsyesno col-md-3 text-right">
                                        <select id="standardpriceincreases_`+oppID+`" class="q3_`+oppID+`">
                                            <option value="1">Yes</option>
                                            <option value="0">No</option>
                                            <option value="2">N/A</option>
                                        </select>
                                    </div>
                                </div>`; //Q3
            //<!-- **** QUESTION3 INNER **** -->
			contractDetailRow +=`<div class="col-md-12  hideit pr0 q3_`+oppID+`_inner">
							<div class="radioBtn crmfield btn-group col-md-12 col-xs-12 mb8 ">
								<div class="fieldlabel col-md-9 text-left">
									<label><span class="QNumber">3.1.</span> Automatic Annual increase?*</label>
								</div>
								<div class="btnsyesno col-md-3 text-right">
                                    <select id="annualincrease_`+oppID+`" class="q3_1_`+oppID+`">
                                        <option value="1">Yes</option>
                                        <option value="0">No</option>
                                        <option value="2">N/A</option>
                                    </select>
                                </div>
							</div>
							<!-- *** QUESTION 3.1 INNER *** -->
							<div class="col-md-12 pr0 hideit q3_1_`+oppID+`_inner">
								<div class="radioBtn crmfield btn-group col-md-12 col-xs-12 mb8 q311">
									<div class="fieldlabel col-md-9 text-left">
										<label><span class="QNumber">3.1.1.</span> Cap on price increases?</label>
									</div>
									<div class="btnsyesno col-md-3 text-right">
                                        <select id="caponpriceincreases_`+oppID+`" class="q3_1_1_`+oppID+`" dataid="`+oppID+`">
                                            <option value="1">Yes</option>
                                            <option value="0">No</option>
                                            <option value="2">N/A</option>
                                        </select>
                                <p class="cap_pinpercent hideit mt10 text-right q3_1_1_`+oppID+`_inner">
                                    <span class="QNumber"></span> 
                                    <span class="inpercent">in 
                                        <select class="selectin input-sm" id="priceincreases_`+oppID+`">
                                            <option value="0">0%</option>
                                            <option value="1">1%</option>
                                            <option value="2">2%</option>
                                            <option selected="" value="3">3%</option>
                                            <option value="4">4%</option>
                                            <option value="5">5%</option>
                                            <option value="6">6%</option>
                                            <option value="7">7%</option>
                                            <option value="8">8%</option>
										</select></span></p>
									</div>
								</div>
							</div>

							<div class="radioBtn crmfield btn-group col-md-12 col-xs-12 mb8">
								<div class="fieldlabel col-md-9 text-left">
									<label><span class="QNumber">3.2.</span> Other price increases outside of annual
										increases standard</label>
								</div>
								<div class="btnsyesno col-md-3 text-right">
                                    <select id="otherpriceincreases_`+oppID+`" class="q3_2_`+oppID+`">
                                        <option value="1">Yes</option>"
                                        <option value="0">No</option>"
                                        <option value="2">N/A</option>"
                                    </select>
                                </div>
							</div>
							<!-- *** QUESTION 3.2 INNER *** -->
							<div class="col-md-12 pr0  hideit q3_2_`+oppID+`_inner">
								<div class="radioBtn crmfield btn-group col-md-12 col-xs-12 mb8">
									<div class="fieldlabel col-md-9 text-left pl16">
										<label><span class="QNumber">3.2.1.</span> Increases allowed</label>
									</div>
									<div class="btnsyesno col-md-3 text-right">
                                        <select id="increasesallowed_`+oppID+`" class="q3_2_1_`+oppID+`">
                                            <option value="1">Yes</option>"
                                            <option value="0">No</option>"
                                            <option value="2">N/A</option>"
                                        </select>
                                    </div>
								</div>
								<div class="radioBtn crmfield btn-group col-md-12 col-xs-12 mb8 ">
									<div class="fieldlabel col-md-9 text-left pl16">
										<label><span class="QNumber">3.2.2.</span> Standard notification requirements
											for price increases</label>
									</div>
									<div class="btnsyesno col-md-3 text-right">
                                        <select id="standardnotificationreq_`+oppID+`" class="q3_2_2_`+oppID+`">
                                            <option value="1">Yes</option>"
                                            <option value="0">No</option>"
                                            <option value="2">N/A</option>"
                                        </select>
                                    </div>
								</div>
							</div> <!-- q3_2_inner end -->
						</div>`;// <!-- q3_inner end -->
                
            contractDetailRow += "</div>";//questionnair end 

            // contractDetailRow = "<table class='table table-responsive table-sm text-center border-0 removetable ' id='" + oppID + "_pt'  style='margin-left:70px;'>";
            // contractDetailRow = "<thead class='table-info'>";
            // contractDetailRow = "<tr> ";
            // contractDetailRow += "<th style='padding:2px;'>";
            // contractDetailRow += "<button class='btn btn-success btn-sm saveProducts' id='" + oppID + "_b' name='" + oppID + "' style='font-size: 9px;float: left;'>Save "
            // + "<i class='fa fa-envelope-square fa-lg' style='float: left;padding: 2px 7px 0px 0px;'></i></button>";
            // contractDetailRow += "</th> ";
            // contractDetailRow += "</tr>";
            // contractDetailRow += "</thead>";
            // contractDetailRow += "<tbody id='" + oppID + "_p'></tbody>";
            // contractDetailRow += "</table>";
            contractDetailRow += "</td>";
            contractDetailRow += "</tr>";



            $(contractDetailRow).insertAfter('#' + oppID + '_CR');
            //getProductTable(oppid);
            var questions = {
                autorenewalforsubscriptionterm : results.entities[i]["ss_autorenewalforsubscriptionterm"],
                standardpaymentterms : results.entities[i]["ss_standardpaymentterms"],
                paymentterm14days : results.entities[i]["ss_paymentterm14days"],
                paymenttermdays : results.entities[i]["ss_paymenttermdays"],
                billinguponsignature : results.entities[i]["ss_billinguponsignature"],
                standardpriceincreases : results.entities[i]["ss_standardpriceincreases"],
                annualincrease : results.entities[i]["ss_annualincrease"],
                caponpriceincreases : results.entities[i]["ss_caponpriceincreases"],
                priceincreases : results.entities[i]["ss_priceincreases"],
                otherpriceincreases : results.entities[i]["ss_otherpriceincreases"],
                increasesallowed : results.entities[i]["ss_increasesallowed"],
                standardnotificationreq : results.entities[i]["ss_standardnotificationreq"],


            }
            
            for(var prop in questions) {
                // console.log("ID => "+oppID+", Questions => "+prop,questions[prop]);
                $("#"+prop+"_"+oppID+" option[value="+questions[prop]+"]").attr("selected","selected");  
                }

        } // end for loop

    } 
        //==========================================nh    


        $("#contractDetailsTblBody").on("click", ".expandTbl", function (eventObj) {
        if ($(this).prop("checked") == true) {
            var target = eventObj.target;
            var closestTR = $(target).closest("tr");
            //nd=======
            var removedTbl = $(closestTR).next();
            $(removedTbl).show();
            //=======nd

        }
        else if ($(this).prop("checked") == false) {
            var target = eventObj.target;
            var closestTR = $(target).closest("tr");
            var removeTbl = $(closestTR).next();
            $(removeTbl).hide();
        }
    });
    function loadData() {
        $("#contractDetailsTblBody").html("");
        resetPartOneFields();
        RetrieveContractDetailsTblData();
        checkInnerQues();
}
</script>
</body></html>