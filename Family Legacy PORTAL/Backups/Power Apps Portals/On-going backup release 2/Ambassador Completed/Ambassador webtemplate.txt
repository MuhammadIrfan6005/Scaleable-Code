<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

{% comment %}
below variable is being used into "sponsored child button"
{%endcomment%}

{%assign sponsorIDSC = "!" %}

<div class="container" style="padding: 0; font-family: " Montserrat", sans-serif;">

  <div class="row sponsorrow" style="margin-top: 100px; margin-right: -390px; margin-bottom: 20px; display:flex;">
    <div class="col-sm-8 col-md-8 col-lg-8">
      <!-- Actual search box -->
      <div class="form-group has-feedback has-search" id="ambassador_div">
        <span class="glyphicon glyphicon-search form-control-feedback"></span>
        <input id="id_namesearch" type="text" list="listit" class="form-control" placeholder="Search by Ambassador...">
      </div>
      <div id="suggest_container" style="display:inline-block;">
        <datalist id="listit" style="margin-right: 100px;">
        </datalist>
      </div>
    </div>
  </div>

  <div class="row" style="margin-bottom: 15px;" id="shareambassadordiv">
    <div class="col-sm-5 col-md-5 col-lg-5"></div>
    <div class="col-sm-4 col-md-4 col-lg-4 tooltipis">
      <span class="tooltiptext" id="myTooltip" hidden="hidden" style="margin-bottom: 10px; display: none">Copy to clipboard</span>
      <a class="btn btn-primary tooltipanchor" id="ambassador_share" style="background-color: #4c75a3;" href="#!"
        role="button"><i class="fa fa-share-alt me-2"></i> Share this ambassador</a>
    </div>
    <div class="col-sm-3 col-md-3 col-lg-3"></div>
  </div>

  {% assign requestId = request.params.data %}
  {% if requestId != blank %}
  {% fetchxml contactimageurl %}
  <fetch>
    <entity name="bna_camplifegroups">
      <filter>
        <condition attribute="bna_ambassadorcamplifegroups" operator="not-null" />
      </filter>
      <link-entity name="contact" from="contactid" to="bna_ambassadorcamplifegroups" link-type="inner" alias="amb">
        <attribute name="contactid" />
        <attribute name="fullname" />
        <attribute name="bna_headshotphoto" />
        <filter>
          <condition attribute="bna_contacttype" operator="in">
            <value>759090001</value>
            <value>759090005</value>
          </condition>
        </filter>
        <filter>
          <condition attribute="contactid" operator="eq" value="{{requestId}}" />
        </filter>
      </link-entity>
    </entity>
  </fetch>
  {% endfetchxml %}
  {%assign totalcontacts = contactimageurl.results.entities.size %}

  {% for item in contactimageurl.results.entities %}
  {%assign contactid = {{item['amb.contactid']}} %}

  <div class="row sponsorrow22" id="childsrow22">
    <div class="col-sm-4 col-md-4 col-lg-4 childrenandchilds"></div>
    <div class="col-sm-4 col-md-4 col-lg-4 childrenandchilds">
      <div class="card allchildrenscards" id="  " style="width: 32rem;">
        <img class="card-img-top" id="id_cardimagetop" src="{{item['amb.bna_headshotphoto']}}" alt=""
          onerror="this.src='https://childphotosdev.blob.core.windows.net/childphotosdev/defaultImage.png'"
          height="300px" width="330px">
        <div class="card-body" style="background-color: #353535; margin-top: -12px; width: 330px; height: 170px; ">
          <h5 class="card-title"
            style="color: white; text-align:center; padding-top: 20px; font-size: 20px; font-weight: 600; margin-bottom: 10px;">
            {{item['amb.fullname']}}</h5>
          <div class="row cardtxtcls">
            <div class="col-sm-12 col-md-12 col-lg-12 ambassadorContactMarginTop" id="total-childsinit"></div>
          </div>
          <div class="row cardtxtcls">
            <div class="col-sm-12 col-md-12 col-lg-12 ambassadorContactMarginTop" id="total-percentage">Total
              Percentage: 0</div>
          </div>
        </div>
        <hr id="seperatr"
          style="height:3px;border-width:0;color:gray;background-color:gray; margin-right:-400px; margin-left: -400px">
      </div>
    </div>
    <div class="col-sm-4 col-md-4 col-lg-4 childrenandchilds"></div>
  </div>

  <div class="row">
    <div class="col-sm-12 col-md-12 col-lg-12" id="noContactfound"
      style="display: none; text-align:center; font-size: 20px; padding-top: 20px">No Ambassador Found</div>
  </div>
  {%- endfor -%}
  {% endif %}

{% if requestId == null or requestId == " " %}
  {% fetchxml pagination_ambassador %}
  <fetch count="1" page="1" distinct="true">
    <entity name="bna_camplifegroups">
      <filter>
        <condition attribute="bna_ambassadorcamplifegroups" operator="not-null" />
      </filter>
      <link-entity name="contact" from="contactid" to="bna_ambassadorcamplifegroups" link-type="inner" alias="amb">
        <attribute name="contactid" />
        <attribute name="fullname" />
        <attribute name="bna_headshotphoto" />
        <filter>
          <condition attribute="bna_contacttype" operator="in">
            <value>759090001</value>
            <value>759090005</value>
          </condition>
        </filter>
      </link-entity>
    </entity>
  </fetch>
  {% endfetchxml %}
  {%assign totalcontacts = pagination_ambassador.results.entities.size %}

  {% for item_new in pagination_ambassador.results.entities %}
  {%assign contactid = {{item_new['amb.contactid']}} %}

  <div class="row sponsorrow" id="childsrow">
    <div class="col-sm-4 col-md-4 col-lg-4 childrenandchilds"></div>
    <div class="col-sm-4 col-md-4 col-lg-4 childrenandchilds">
      <div class="card allchildrenscards" id="  " style="width: 32rem;">
        <img class="card-img-top" id="id_cardimagetop" src="{{item_new['amb.bna_headshotphoto']}}" alt=""
          onerror="this.src='https://childphotosdev.blob.core.windows.net/childphotosdev/defaultImage.png'"
          height="300px" width="330px">
        <div class="card-body" style="background-color: #353535; margin-top: -12px; width: 330px; height: 170px; ">
          <h5 class="card-title"
            style="color: white; text-align:center; padding-top: 20px; font-size: 20px; font-weight: 600; margin-bottom: 10px;">
            {{item_new['amb.fullname']}}</h5>
          <div class="row cardtxtcls">
            <div class="col-sm-12 col-md-12 col-lg-12 ambassadorContactMarginTop" id="total-childsinit"></div>
          </div>
          <div class="row cardtxtcls">
            <div class="col-sm-12 col-md-12 col-lg-12 ambassadorContactMarginTop" id="total-percentage">Total
              Percentage: 0</div>
          </div>
        </div>
        <hr id="seperatr"
          style="height:3px;border-width:0;color:gray;background-color:gray; margin-right:-400px; margin-left: -400px">
      </div>
    </div>
    <div class="col-sm-4 col-md-4 col-lg-4 childrenandchilds"></div>
  </div>

  <div class="row">
    <div class="col-sm-12 col-md-12 col-lg-12" id="noContactfound"
      style="display: none; text-align:center; font-size: 20px; padding-top: 20px">No Ambassador Found</div>
  </div>
  {%- endfor -%}
  {% endif %}
  {%comment%}

  {%endcomment%}


  {% fetchxml AmbassadorInCampLifeGroup %}
  <fetch>
    <entity name="bna_camplifegroups">
      <attribute name="bna_camplifegroupsid" />
      <filter>
        <condition attribute="bna_ambassadorcamplifegroups" operator="eq" value='{{contactid}}' uitype="contact" />
      </filter>
    </entity>
  </fetch>
  {% endfetchxml %}
  {%assign AmbassadorCampGroups = AmbassadorInCampLifeGroup.results.entities.size %}

  {% if AmbassadorCampGroups > 0 %}
  {% assign allcampIDS = '' | split: '' %}
  {% for ambassadorCamps in AmbassadorInCampLifeGroup.results.entities %}
  {% assign campIDS = {{ambassadorCamps.bna_camplifegroupsid}} %}
  {% assign conditionstart = '<value>' %}
    {% assign conditionend = '</value>' %}
  {% assign combine = conditionstart | append: campIDS | append: conditionend %}
  {% assign allcampIDS = allcampIDS | concat: combine %}
  {%- endfor -%}

  {% fetchxml AmbassadorCampLifeGroupChildrens %}

  <fetch>
    <entity name="bna_childtocamplifegroup">
      <attribute name="bna_childcontact" />
      <filter>
        <condition attribute="bna_camplifegroup" operator="in" uitype="bna_camplifegroups" value="">
          {{allcampIDS}}
        </condition>
        <condition attribute="statecode" operator="eq" value="0" />
      </filter>
      <link-entity name="contact" from="contactid" to="bna_childcontact" alias="ch">
        <attribute name="fullname" />
        <attribute name="contactid" />
        <attribute name="gendercode" />
        <attribute name="birthdate" />
        <attribute name="bna_headshotphoto" />
        <attribute name="bna_currentprogram1" />
        <attribute name="msnfp_age" />
        <link-entity name="bna_program" from="bna_programid" to="bna_currentprogram1" link-type="outer" alias="pro">
          <attribute name="bna_name" />
        </link-entity>
        <link-entity name="bna_community" from="bna_contact" to="contactid" link-type="outer" alias="com">
          <attribute name="bna_name" />
        </link-entity>
      </link-entity>
    </entity>
  </fetch>

  {% endfetchxml %}

  {%assign AmbassadorCampchildrens = AmbassadorCampLifeGroupChildrens.results.entities.size %}

  <div class="row sponsorrow">
    {% for child in AmbassadorCampLifeGroupChildrens.results.entities %}
    {%assign childdate = child['ch.birthdate'] %}
    {% assign contactidis = {{child['ch.contactid']}} %}

    <div class="col-sm-4 col-md-4 col-lg-4 childrenandchilds">
      <div class="card allchildrenscards" id="  " style="width: 32rem;">
        <img class="card-img-top" id="id_cardimagetop" src="{{child['ch.bna_headshotphoto']}}" alt=""
          onerror="this.src='https://childphotosdev.blob.core.windows.net/childphotosdev/defaultImage.png'"
          height="300px" width="330px">
        <div class="card-body" style="background-color: #353535; margin-top: -12px; width: 330px; height: 270px; ">
          <h5 class="card-title"
            style="color: white; text-align:center; padding-top: 20px; font-size: 20px; font-weight: 600; margin-bottom: 10px;">
            {{child['ch.fullname']}}</h5>
          <div class="row card-text cardtxtcls">
            <div class="col-sm-8 col-md-8 col-lg-8">Age: {{child['ch.msnfp_age']}}</div>
            <div class="col-sm-4 col-md-4 col-lg-4">{{child['ch.gendercode'].label}}</div>
          </div>
          <div class="row cardtxtcls">
            <div class="col-sm-12 col-md-12 col-lg-12">Program: {{child['pro.bna_name']}}</div>
          </div>
          <div class="row cardtxtcls">
            <div class="col-sm-12 col-md-12 col-lg-12">Commuity: {{child['com.bna_name']}}</div>
          </div>
          <div class="row cardtxtcls">
            <div class="col-sm-12 col-md-12 col-lg-12">Birthday: {{ childdate | date: 'dd/MM/yyyy' }}</div>
          </div>
          <button class="btn" onclick="redirectfunction(this)" id="sponsormebtn"
            style="color: white; font: message-box; background-color: #00984d; margin: 10px 0 25px 90px; padding: 10px 30px 10px 30px; opacity: 2;"
            type="submit" value="{{child['ch.fullname']}} {{sponsorIDSC}}{{child['ch.contactid']}}">SPONSOR ME</button>
        </div>
      </div>
    </div>
    {%- endfor -%}
  </div>
  {% endif %}

  <div class="row">
    <div class="col-sm-12 col-md-12 col-lg-12" id="nochildcontactfound"
      style="display:none; text-align:center; font-size: 20px; padding-top: 20px">The Child-Contact records are not
      found for this Ambassador</div>
  </div>

  <div class="row" id="paginationdiv">
    <div class="col-sm-12 col-md-12 col-lg-12">
      <ul class="pager">
        <li class="previous"><a href="#" id="previous" style="margin-left: 1000px;">Previous</a></li>
        <li class="next"><a href="#" id="next">Next</a></li>
      </ul>
    </div>
  </div>
</div>

<div class="preload"></div>


<script>

  var requestId = '{{requestId}}';
  console.log("requestId" + requestId);

  if(requestId != ""){
   $("#ambassador_div").hide();
   $("#shareambassadordiv").hide();
   $("#paginationdiv").hide();
  }

  var shareable_link = "";
  var contactidis = '{{contactid}}';
  console.log("script start contactid " + contactidis);
  shareable_link = 'https://portaldev-familylegacy.powerappsportals.com/ambassador?data=' + contactidis;

  var date = '{{childdate}}';
  console.log("date" + date);
  var ambassador = '{{contactid}}';
  document.getElementsByClassName("preload")[0].style.display = 'none';
  $(".container").css("opacity", 2);

  var searchedvalue = "";

  var AmbassadorCampchildrens = '{{AmbassadorCampchildrens}}';
  $("#total-childsinit").append("Total Records: " + AmbassadorCampchildrens);

  if (AmbassadorCampchildrens == 0) {
    $("#nochildcontactfound").show();
  }
  var pagenumber = 1;
  if (pagenumber <= 1) {
    $('#previous').css("cursor", "not-allowed");
    $('#previous').css("pointer-events", "none");
  }

  $("#next").on("click", function () {
    $("#myTooltip").hide();
    document.getElementsByClassName("preload")[0].style.display = 'inline';
    $(".container").css("opacity", 0.2);
    $($(".fa-spinner")[0]).css("opacity", 2);

    pagenumber = pagenumber + 1;
    if (pagenumber > 1) {
      $('#previous').css("cursor", "pointer");
      $('#previous').css("pointer-events", "fill");
    }
    pagination(pagenumber);

  });
  $("#previous").on("click", function () {
    //showing the loader on api call start
    document.getElementsByClassName("preload")[0].style.display = 'inline';
    $(".container").css("opacity", 0.2);
    $($(".fa-spinner")[0]).css("opacity", 2);

    pagenumber = pagenumber - 1;
    if (pagenumber <= 1) {
      $('#previous').css("cursor", "not-allowed");
      $('#previous').css("pointer-events", "none");
    }

    if (searchedvalue != "" && pagenumber <= 0) {
      $(".childrenandchilds").remove();
      $("#noContactfound").show();
    }
    else {
      pagination(pagenumber);
    }
  });
  function pagination(pagenumber) {
    var fetchData = {
      bna_contacttype: "759090001",
      bna_contacttype2: "759090005"
    };
    var fetchXml = [
      "<fetch count='1' page='" + pagenumber + "' distinct='true'>",
      "  <entity name='bna_camplifegroups'>",
      "    <filter>",
      "      <condition attribute='bna_ambassadorcamplifegroups' operator='not-null' />",
      "    </filter>",
      "    <link-entity name='contact' from='contactid' to='bna_ambassadorcamplifegroups' link-type='inner' alias='amb'>",
      "      <attribute name='contactid' />",
      "      <attribute name='fullname' />",
      "      <attribute name='bna_headshotphoto'/>",
      "      <filter>",
      "        <condition attribute='bna_contacttype' operator='in'>",
      "          <value>", fetchData.bna_contacttype/*759090001*/, "</value>",
      "          <value>", fetchData.bna_contacttype2/*759090005*/, "</value>",
      "        </condition>",
      "      </filter>",
      "    </link-entity>",
      "  </entity>",
      "</fetch>",
    ].join("");

    fetchXml = "?fetchXml=" + encodeURIComponent(fetchXml);
    var initrequest = new XMLHttpRequest();
    initrequest.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        var myArr = JSON.parse(this.responseText);
        makecontacts(myArr);
      }
    };
    initrequest.open("GET", "https://portaldev-familylegacy.powerappsportals.com/_api/bna_camplifegroupses" + fetchXml, true);
    initrequest.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
    initrequest.send();

  }
  //function to read contact data
  function makecontacts(arr) {
    document.getElementsByClassName("preload")[0].style.display = 'none';
    $(".container").css("opacity", 2);

    if (arr.value.length == 0) {
      //disabling next button
      $("#next").css("cursor", "not-allowed");
      $("#next").css("pointer-events", "none");

      $("#shareambassadordiv").hide();
      $("#noContactfound").show();
      $(".childrenandchilds").remove();
      // $("#nochildcontactfound").hide();
    }
    else {
      //Enabling next button if ambassador found
      $('#next').css("cursor", "pointer");
      $('#next').css("pointer-events", "fill");
      $(".container").css("opacity", 2);

      var i;
      // hiding all cards
      $(".childrenandchilds").remove();
      for (i = 0; i < arr.value.length; i++) {
        $("#noContactfound").hide();
        $("#nochildcontactfound").hide();
        // making new cards with relevent data
        if (arr.value[i]["amb.bna_headshotphoto"] == undefined) {
          arr.value[i]["amb.bna_headshotphoto"] = "https://childphotosdev.blob.core.windows.net/childphotosdev/defaultImage.png";
        }
        contactidis = arr.value[i]["amb.contactid"];
        console.log("Inside make contact fun " + contactidis);

        shareable_link = 'https://portaldev-familylegacy.powerappsportals.com/ambassador?data=' + contactidis;

        console.log("shareable_link " + shareable_link);

        var initdata = '<div class="col-md-offset-4 col-sm-4 col-md-4 col-lg-4 childrenandchilds">';
        initdata = initdata + '<div class="card" style="width: 32rem;">';
        initdata = initdata + '<img class="card-img-top" src="' + arr.value[i]["amb.bna_headshotphoto"] + '" alt="https://childphotosdev.blob.core.windows.net/childphotosdev/defaultImage.png" style="height:300px; width:330px;"/>';
        initdata = initdata + '<div class="card-body" style="color: white; background-color: #353535; margin-top: -12px; width: 330px; height: 170px;">';
        initdata = initdata + '<h5 class="card-title" style="color: white; text-align:center; padding-top: 20px; font-size: 20px; font-weight: 600; margin-bottom: 10px;">' + arr.value[i]['amb.fullname'] + '</h5>';
        initdata = initdata + '<div class="row cardtxtcls"><div class="col-sm-12 col-md-12 col-lg-12 ambassadorContactMarginTop" id="total-Contacts">Total Records:0</div></div>';
        initdata = initdata + ' <div class="row cardtxtcls"><div class="col-sm-12 col-md-12 col-lg-12 ambassadorContactMarginTop" id="total-percentage">Total Percentage: 0</div></div>';
        initdata = initdata + '</div>';
        initdata = initdata + '<hr style="height:3px;border-width:0;color:gray;background-color:gray; margin-right:-400px; margin-left: -400px">';
        initdata = initdata + '</div>';
        initdata = initdata + '</div>';
        $($(".sponsorrow")[1]).append(initdata);
        getambassadorCampLifeGroups(arr.value[i]['amb.contactid']);
      }
    }
  }

  $('#ambassador_share').click(function () {
    console.log("clicked");

    /* Copy the text inside the text field */
    navigator.clipboard.writeText(shareable_link);

    /* Alert the copied text */
    console.log("Copied the text: " + shareable_link);
  });
  $("#ambassador_share").mouseout(function () {
    console.log("mouseout");
    var tooltip = document.getElementById("myTooltip");
    tooltip.innerHTML = "copied to clipboard";
  })
  function getambassadorCampLifeGroups(ambassadorGuid) {
    //first get the "Camp life groups of a perticular embassador"

    var fetchData = {
      "bna_ambassadorcamplifegroups": ambassadorGuid
    };
    var fetchXmlcamplife = [
      "<fetch>",
      "  <entity name='bna_camplifegroups'>",
      "    <attribute name='bna_camplifegroupsid'/>",
      "    <filter>",
      "      <condition attribute='bna_ambassadorcamplifegroups' operator='eq' value='", fetchData.bna_ambassadorcamplifegroups/*fe719d6c-39ca-ec11-a7b5-000d3a1b7f51*/, "' uiname='Cynthia Knight' uitype='contact'/>",
      "    </filter>",
      "  </entity>",
      "</fetch>"
    ].join("");

    //to get the "Camp life Groups" of a embassador making API Call

    fetchXmlcamplife = "?fetchXml=" + encodeURIComponent(fetchXmlcamplife);
    var initrequestchild = new XMLHttpRequest();
    initrequestchild.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        var myArr = JSON.parse(this.responseText);
        if (myArr.value.length != 0) {
          var ambassGroupIds = "";
          for (var g = 0; g < myArr.value.length; g++) {
            ambassGroupIds += '"<value>' + myArr.value[g].bna_camplifegroupsid + '</value>"';
          }
          childsFromAmbassadorCampGroups(ambassGroupIds);
        }
        else {
          // $("#nochildcontactfound").show();
        }
      }
    };
    initrequestchild.open("GET", "https://portaldev-familylegacy.powerappsportals.com/_api/bna_camplifegroupses" + fetchXmlcamplife, false);
    initrequestchild.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
    initrequestchild.send();
  }
  function childsFromAmbassadorCampGroups(ambassGroupIds) {
    var fetchXml = [
      "<fetch>",
      "  <entity name='bna_childtocamplifegroup'>",
      "    <attribute name='bna_childcontact'/>",
      "    <filter>",
      "      <condition attribute='bna_camplifegroup' operator='in' uitype='bna_camplifegroups'>",
      ambassGroupIds,
      "      </condition>",
      "      <condition attribute='statecode' operator='eq' value='0' />",
      "    </filter>",
      "    <link-entity name='contact' from='contactid' to='bna_childcontact' alias='as'>",
      "      <attribute name='fullname'/>",
      "     <attribute name='contactid'/>",
      "      <attribute name='gendercode'/>",
      "      <attribute name='birthdate'/>",
      "      <attribute name='bna_headshotphoto'/>",
      "      <attribute name='bna_currentprogram1'/>",
      "      <attribute name='msnfp_age'/>",
      "      <link-entity name='bna_program' from='bna_programid' to='bna_currentprogram1' link-type='outer' alias='pro'>",
      "        <attribute name='bna_name'/>",
      "      </link-entity>",
      "      <link-entity name='bna_community' from='bna_contact' to='contactid' link-type='outer' alias='com'>",
      "        <attribute name='bna_name'/>",
      "      </link-entity>",
      "    </link-entity>",
      "  </entity>",
      "</fetch>"
    ].join("");
    fetchXml = "?fetchXml=" + encodeURIComponent(fetchXml);
    var initrequestchild = new XMLHttpRequest();
    initrequestchild.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        var myArr = JSON.parse(this.responseText);
        if (myArr.value.length != 0) {
          $("#nochildcontactfound").hide();
          iterateChildContact(myArr);
        }
        else {
          $("#nochildcontactfound").show();
        }
      }
    };
    initrequestchild.open("GET", "https://portaldev-familylegacy.powerappsportals.com/_api/bna_childtocamplifegroups" + fetchXml, false);
    initrequestchild.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
    initrequestchild.send();
  }
  function iterateChildContact(data) {
    var i;
    $("#total-Contacts").empty();
    $("#total-Contacts").append("Total Records: " + data.value.length);
    for (i = 0; i < data.value.length; i++) {
      if (data.value[i]["as.bna_headshotphoto"] == undefined) {
        data.value[i]["as.bna_headshotphoto"] = "https://childphotosdev.blob.core.windows.net/childphotosdev/defaultImage.png";
      }
      if (data.value[i]["as.birthdate"] != undefined) {
        data.value[i]["as.birthdate"] = moment(data.value[i]["as.birthdate"], "YYYY.MM.DD").format("DD-MM-YYYY");
      }
      var childdata = '<div class="col-sm-4 col-md-4 col-lg-4 childrenandchilds">';
      childdata = childdata + '<div class="card" style="width: 32rem;">';
      childdata = childdata + '<img class="card-img-top" src="' + data.value[i]["as.bna_headshotphoto"] + '" alt="https://childphotosdev.blob.core.windows.net/childphotosdev/defaultImage.png" style="height:300px; width:330px;"/>';
      childdata = childdata + '<div class="card-body" style="color: white; background-color: #353535; margin-top: -12px; width: 330px; height: 290px;">';
      childdata = childdata + '<h5 class="card-title" style="color: white; text-align:center; padding-top: 20px; font-size: 20px; font-weight: 600; margin-bottom: 10px;">' + data.value[i]["as.fullname"] + '</h5>';
      childdata = childdata + '<div class="row card-text selectedrow"><div class="col-sm-6 col-md-6 col-lg-6">Age: ' + data.value[i]["as.msnfp_age@OData.Community.Display.V1.FormattedValue"] + '</div><div class="col-sm-6 col-md-6 col-lg-6"> ' + data.value[i]["as.gendercode@OData.Community.Display.V1.FormattedValue"] + '</div></div>';
      childdata = childdata + '<div class="row card-text selectedrow"><div class="col-sm-12 col-md-12 col-lg-12">Program: ' + data.value[i]["pro.bna_name"] + '</div></div>';
      childdata = childdata + '<div class="row card-text selectedrow"><div class="col-sm-12 col-md-12 col-lg-12">Community: ' + data.value[i]["com.bna_name"] + '</div></div>';
      childdata = childdata + '<div class="row card-text selectedrow"><div class="col-sm-12 col-md-12 col-lg-12">Birthdate: ' + data.value[i]["as.birthdate"] + '</div></div>';
      childdata = childdata + '<button class="btn" onclick="redirectfunction(this)" id="sponsormebtn" style="color: white; font: message-box;background-color: #00984d; margin: 10px 0 25px 70px; padding: 10px 30px 10px 30px; opacity: 2;" type="submit" value="' + data.value[i]["as.fullname"] + " !" + data.value[i]["as.contactid"] + '"> SPONSOR ME</button>';
      childdata = childdata + '</div>';
      childdata = childdata + '</div>';
      childdata = childdata + '</div>';
      $($(".sponsorrow")[2]).append(childdata);
    }
  }
  //redirect function to checkout page: 
  function redirectfunction(childname) {
    localStorage.setItem('parameterchild', ('false'));
    localStorage.setItem('givemonthly', ('true'));
    var sponsoredname = childname.value;
    var name = sponsoredname.split(" ");
    var fullname = name[0];
    var split = name[1].substr(0, 1);
    fullname += " " + split;
    fullname += name[2]
    console.log("fullname" + fullname);


    //to check either 'child being sponsored' already exist into storage
    var getLocalStorage = localStorage.getItem("UserInput");
    if (getLocalStorage != null) {
      var arr = [];
      arr = getLocalStorage.split(",");

      for (i = 0; i < arr.length; i++) {
        var Val = arr[i]
        if (Val == fullname) {
          localStorage.setItem('parameterchild', ('true'));
          window.location.href = 'https://portaldev-familylegacy.powerappsportals.com/checkout/';
        }
      }
    }
    //check end
    window.location.href = 'https://portaldev-familylegacy.powerappsportals.com/checkout/?data=' + fullname;
  }
  //searching
  //searching on enter event in ambassador input
  $("#id_namesearch").keypress(function (e) {
    if (e.which == 13) {
      document.getElementsByClassName("preload")[0].style.display = 'inline';
      $(".container").css("opacity", 0.2);
      $($(".fa-spinner")[0]).css("opacity", 2);
      searchresults();
    }
  });

  $('#id_namesearch').keyup(_.debounce(function (e) {
    if ($('#id_namesearch:text').val().length != 0) {
        if( e.which === 8 ){ return false; }
    document.getElementsByClassName("preload")[0].style.display = 'inline';
    $(".container").css("opacity", 0.2);
    $($(".fa-spinner")[0]).css("opacity", 2);
    searchresults();
    }
  }, 500));
    

    
  $("#id_namesearch").keydown(function (e) {
   document.getElementsByClassName("preload")[0].style.display = 'none';
    $(".container").css("opacity", 2);
  });


  $("#id_namesearch").change(function () {
    document.getElementsByClassName("preload")[0].style.display = 'inline';
    $(".container").css("opacity", 0.2);
    $($(".fa-spinner")[0]).css("opacity", 2);
    console.log("keychange");
    searchresults();
  });
  //function use for retrieve results for search
  function searchresults() {
    searchedvalue = $("#id_namesearch").val();
    if (searchedvalue != "") {
      var fetchData = {
        bna_contacttype: "759090001",
        bna_contacttype2: "759090005",
        fullname: "%" + searchedvalue + "%"
      };
      var fetchXml = [
        "<fetch>",
        "  <entity name='bna_camplifegroups'>",
        "    <filter>",
        "      <condition attribute='bna_ambassadorcamplifegroups' operator='not-null' />",
        "    </filter>",
        "    <link-entity name='contact' from='contactid' to='bna_ambassadorcamplifegroups' link-type='inner' alias='amb'>",
        "      <attribute name='contactid' />",
        "      <attribute name='fullname' />",
        "      <attribute name='bna_headshotphoto'/>",
        "      <filter>",
        "        <condition attribute='bna_contacttype' operator='in'>",
        "          <value>", fetchData.bna_contacttype, "</value>",
        "          <value>", fetchData.bna_contacttype2, "</value>",
        "        </condition>",
        "      </filter>",
        "      <filter>",
        "        <condition attribute='fullname' operator='like' value='", fetchData.fullname, "'/>",
        "      </filter>",
        "    </link-entity>",
        "  </entity>",
        "</fetch>",
      ].join("");

      fetchXmlcontact = "?fetchXml=" + encodeURIComponent(fetchXml);
      var initrequestchild = new XMLHttpRequest();
      initrequestchild.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          var myArr = JSON.parse(this.responseText);
          if (myArr.value.length != 0) {
            $("#nochildcontactfound").hide();
            $("#noContactfound").hide();
            if (myArr.value.length == 1) {
              $("#shareambassadordiv").show();
              makecontacts(myArr);
            }
            else if (myArr.value.length > 1) {
              var options = "";
              for (var i = 0; i < myArr.value.length; i++) {
                options += '<option style="height: 34px; width: 153px;" data-value="' + myArr.value[i]["amb.contactid"] + '" value="' + myArr.value[i]["amb.fullname"] + '" />'; // Storing options in variable
              }
              document.getElementById('listit').innerHTML = options;
              document.getElementsByClassName("preload")[0].style.display = 'none';
              $(".container").css("opacity", 2);
            }
          }
          else {
            //hide the contacts and child-contacts if no filter satisfied. and show contact and child-contact un-availability
            $("#shareambassadordiv").hide();
            $("#noContactfound").show();
            document.getElementsByClassName("preload")[0].style.display = 'none';
            $(".container").css("opacity", 2);
            $(".childrenandchilds").remove();
          }
        }
      };
      initrequestchild.open("GET", "https://portaldev-familylegacy.powerappsportals.com/_api/bna_camplifegroupses" + fetchXmlcontact, true);
      initrequestchild.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
      initrequestchild.send();
    }
  }
</script>